
CREATE OR REPLACE STORAGE integration s3_retail
TYPE = EXTERNAL_STAGE
STORAGE_PROVIDER = S3
ENABLED = TRUE
STORAGE_AWS_ROLE_ARN = "arn:aws:iam::186165438532:role/retailrolewithpomesh"
STORAGE_ALLOWED_LOCATIONS = ('s3://retailanalyticswithpomesh/');

DESC integration s3_retail;

create or replace stage retail_stage
URL= 's3://retailanalyticswithpomesh'
FILE_FORMAT = CSV_FORMAT
STORAGE_INTEGRATION = s3_retail;

CREATE FILE FORMAT CSV_FORMAT
TYPE = CSV
COMPRESSION = AUTO
RECORD_DELIMITER = '\n'
FIELD_DELIMITER = ','
SKIP_HEADER = 1;

LIST @retail_stage;

SHOW STAGES;

CREATE OR REPLACE PIPE RETAIL_SNOWPIPE_CAMPAIGN_DESC AUTO_INGEST = TRUE AS
COPY INTO "RETAILS"."PUBLIC"."CAMPAIGN_DESC_RAW"
FROM '@retail_stage/CAMPAIGN_DESC/'
FILE_FORMAT = CSV_FORMAT;

CREATE OR REPLACE PIPE RETAIL_SNOWPIPE_CAMPAIGN AUTO_INGEST = TRUE AS
COPY INTO "RETAILS"."PUBLIC"."CAMPAIGN_RAW"
FROM '@retail_stage/CAMPAIGN/'
FILE_FORMAT = CSV_FORMAT;

CREATE OR REPLACE PIPE RETAIL_SNOWPIPE_COUPON AUTO_INGEST = TRUE AS
COPY INTO "RETAILS"."PUBLIC"."COUPON_RAW"
FROM '@retail_stage/COUPON/'
FILE_FORMAT = CSV_FORMAT;

CREATE OR REPLACE PIPE RETAIL_SNOWPIPE_COUPON_REDEMPT AUTO_INGEST = TRUE AS
COPY INTO "RETAILS"."PUBLIC"."COUPON_REDEMPT_RAW"
FROM '@retail_stage/COUPON_REDEMPT/'
FILE_FORMAT = CSV_FORMAT;

CREATE OR REPLACE PIPE RETAIL_SNOWPIPE_DEMOGRAPHIC AUTO_INGEST = TRUE AS
COPY INTO "RETAILS"."PUBLIC"."DEMOGRAPHIC_RAW"
FROM '@retail_stage/DEMOGRAPHIC/'
FILE_FORMAT = CSV_FORMAT;

CREATE OR REPLACE PIPE RETAIL_SNOWPIPE_PRODUCT AUTO_INGEST = TRUE AS
COPY INTO "RETAILS"."PUBLIC"."PRODUCT_RAW"
FROM '@retail_stage/PRODUCT/'
FILE_FORMAT = CSV_FORMAT;

CREATE OR REPLACE PIPE RETAIL_SNOWPIPE_TRANSACTIONS AUTO_INGEST = TRUE AS
COPY INTO "RETAILS"."PUBLIC"."TRANSACTION_RAW"
FROM '@retail_stage/TRANSACTION/'
FILE_FORMAT = CSV_FORMAT;

SHOW PIPES;

SELECT COUNT(*) FROM demographic_RAW;
SELECT COUNT(*) FROM CAMPAIGN_DESC_RAW;
SELECT COUNT(*) FROM CAMPAIGN_RAW;
SELECT COUNT(*) FROM PRODUCT_RAW;
SELECT COUNT(*) FROM COUPON_RAW;
SELECT COUNT(*) FROM COUPON_REDEMPT_RAW;
SELECT COUNT(*) FROM TRANSACTION_RAW;


SELECT * FROM demographic_RAW;
SELECT * FROM CAMPAIGN_DESC_RAW;
SELECT * FROM CAMPAIGN_RAW;
SELECT * FROM PRODUCT_RAW;
SELECT * FROM COUPON_RAW;
SELECT * FROM COUPON_REDEMPT_RAW;
SELECT * FROM TRANSACTION_RAW;

ALTER PIPE RETAIL_SNOWPIPE_CAMPAIGN_DESC refresh;
ALTER PIPE RETAIL_SNOWPIPE_CAMPAIGN refresh;
ALTER PIPE RETAIL_SNOWPIPE_COUPON refresh;
ALTER PIPE RETAIL_SNOWPIPE_COUPON_REDEMPT refresh;
ALTER PIPE RETAIL_SNOWPIPE_DEMOGRAPHIC refresh;
ALTER PIPE RETAIL_SNOWPIPE_PRODUCT refresh;
ALTER PIPE RETAIL_SNOWPIPE_TRANSACTIONS refresh;

select * from RETAILS.PUBLIC.CAMPAIGN_DESC_NEW ; 
select * from RETAILS.PUBLIC.COUPON_REDEMPT_NEW;
SELECT * FROM RETAILS.PUBLIC.TRANSACTION_NEW ;
